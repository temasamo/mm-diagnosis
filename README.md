# MM Diagnosis

## Pillow診断アプリの一連の流れ（必須）

### 重要な開発ルール
**どこかのページを開発した際に、そのページだけでなく、全体の流れを損なわないようにする**

### 一連の流れ（①〜④）
1. **①** `http://localhost:3001/pillow` - ランディングページ
2. **②** `http://localhost:3001/pillow/diagnosis` - 診断ページ（ラジオボタン形式、複数選択対応）
3. **③** `http://localhost:3001/pillow/preview?c=...` - プレビューページ（JSON圧縮されたデータを受け取る）
   - **AIからの追加の質問**: プレビューページに遷移した際に「AIからの追加の質問」がポップアップで表示される
   - **現在使っている枕の素材**に関する追加質問が表示され、ユーザーの回答を収集する
   - **重要**: このポップアップは必ず表示される（診断ページの「好きな素材」とは異なる質問）
4. **④** `http://localhost:3001/pillow/result` - 結果ページ
   - **AIからのコメント**: 診断結果に基づいてAIが生成した理由文が表示される
   - **重要**: このAIコメント欄は一連の流れの必須要素として実装されている

### データフロー
- **②→③**: `JSON.stringify(answers)`で圧縮してURLパラメータに渡す
- **③→④**: プレビューページから結果ページへの遷移
- **データ整合性**: 複数選択データも配列として正しく処理される

### 技術仕様
- **診断ページ**: ラジオボタン形式、`concerns`と`neck_shoulder_issues`は複数選択可能なチェックボックス
- **状態管理**: Zustandを使用
- **データ圧縮**: `JSON.stringify`でURLパラメータに渡す
- **一連の流れ**: 必ず①→②→③→④の順序で動作することを確認

### 開発時の注意事項
1. 各ページを修正する際は、必ず一連の流れ（①〜④）が正常に動作することを確認
2. データの受け渡し（特にJSON圧縮）を壊さないように注意
3. 複数選択データの処理を正しく実装
4. プレビューページと結果ページの連携を維持
5. **AIからの質問ポップアップ**: プレビューページでの「現在使っている枕の素材」質問ポップアップを必ず維持する
6. **AIからのコメント欄**: 結果ページでのAI理由文表示を必ず維持する

### 枕診断AI開発ルール
**既存の流れや結果等を壊す恐れがある場合はその都度停止し、判断を仰ぐようにしてください**

- 既存の診断フロー（①〜④）は一切変更しない
- 新しい機能は既存機能の上に追加するのみ
- データの受け渡しや状態管理の既存仕様を維持する
- フォールバック機能を必ず実装し、APIキー未設定時でもアプリが動作するようにする
- **AIからの質問ポップアップとAIからのコメント欄は一連の流れの必須要素**
- **質問の意図の違い**: 診断ページは「好きな素材」、プレビューページのポップアップは「現在使っている枕の素材」

### 環境変数設定
AI理由文機能を使用する場合は、以下の環境変数を設定してください：

```bash
# apps/pillow/.env.local
OPENAI_API_KEY=your_openai_api_key_here
PILLOW_ENABLE_AI_REASON=true
```

**注意**: APIキーが未設定の場合でも、フォールバック機能によりアプリは正常に動作します。

---

# 枕診断AI / mm-diagnosis-pillow

## 開発フロー
- `main` = 本番用（Production Deploy）
- `feat/new-development` = 開発・検証用（Preview Deploy）

## デプロイ
- Preview: `feat/new-development` ブランチにプッシュすると自動デプロイ
- Production: `main` ブランチにマージすると自動デプロイ

## ロールバック
- Vercel Dashboard → Deployments → 安定版を `Promote to Production`
- CLI: `vercel rollback <deployment-id>`

## 環境変数（最低限）
- `RAKUTEN_APP_ID`（必須）
- `NEXT_PUBLIC_SUPABASE_URL`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`（任意）
- `SUPABASE_SERVICE_ROLE`（任意、無ければ no-op）

## 注意点
- `main` への直 push 禁止（必ず PR 経由）
- CI smoke test (items.length >= 3) が通らないと Merge 不可 